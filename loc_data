import pandas as pd
import os

# Đường dẫn tới thư mục chứa các file cần xử lý
input_folder = "D:\\Do_an_2\\Project_2\\a"  # Thay 'path/to/your/folder' bằng đường dẫn thực tế

# Thư mục đầu ra để lưu các file đã xử lý
output_folder = 'b'
os.makedirs(output_folder, exist_ok=True)  # Tạo thư mục nếu chưa tồn tại

# Lấy danh sách các file trong thư mục
file_list = [f for f in os.listdir(input_folder) if f.endswith('.csv') or f.endswith('.xlsx')]

# Xác định khoảng thời gian cần lọc
start_date = pd.to_datetime('2022-06-22')
end_date = pd.to_datetime('2023-10-06')

for file_name in file_list:
    file_path = os.path.join(input_folder, file_name)
    try:
        # Đọc dữ liệu từ file
        if file_name.endswith('.csv'):
            df = pd.read_csv(file_path)
        elif file_name.endswith('.xlsx'):
            df = pd.read_excel(file_path)
        else:
            print(f"Định dạng file không hỗ trợ: {file_name}")
            continue
        
        # Chuyển đổi cột 'date' sang định dạng datetime nếu chưa
        df['date'] = pd.to_datetime(df['date'])
        
        # Kiểm tra ngày đầu tiên và cuối cùng của cột 'date'
        first_date = df['date'].min()
        last_date = df['date'].max()
        print(f"Kết quả cho file {file_name}:")
        print(f"Ngày đầu tiên: {first_date}")
        print(f"Ngày cuối cùng: {last_date}")
        
        # Lọc các dòng có ngày từ 22/06/2022 đến 06/10/2023
        df_filtered = df[(df['date'] >= start_date) & (df['date'] <= end_date)]
        
        # Xóa cột '_id' nếu tồn tại
        if '_id' in df_filtered.columns:
            df_filtered = df_filtered.drop(columns=['_id'])
        
        # Chuyển đổi cột 'date' chỉ giữ lại năm-tháng-ngày
        df_filtered['date'] = df_filtered['date'].dt.date
        
        # Lưu kết quả vào file khác
        output_file = os.path.join(output_folder, f'processed_{file_name}')
        df_filtered.to_csv(output_file, index=False)
        print(f"File kết quả đã được lưu tại: {output_file}\n")
    
    except Exception as e:
        print(f"Đã xảy ra lỗi khi xử lý file {file_name}: {e}")
